# ==============================================================================
# ã€é€šç”¨å¯å¤ç”¨æ¨¡æ¿ã€‘Telegram æ¶ˆæ¯æ¨é€ï¼ˆç»Ÿä¸€é…ç½®ç‰ˆï¼‰
# åŠŸèƒ½ï¼šæ‰€æœ‰é¡¹ç›®å¯è°ƒç”¨æ­¤æ¨¡æ¿å‘é€ TG é€šçŸ¥ï¼ŒTG å¯†é’¥ç»Ÿä¸€å­˜å‚¨åœ¨æ¨¡æ¿ä»“åº“
# é€‚ç”¨åœºæ™¯ï¼šå¤š Fork ä»“åº“åŒæ­¥ç»“æœé€šçŸ¥ã€ä»»åŠ¡æ‰§è¡Œç»“æœé€šçŸ¥ç­‰
# ç»´æŠ¤è€…ï¼šä½ çš„ GitHub ç”¨æˆ·å
# æœ€åæ›´æ–°ï¼š2026-01-11
# ==============================================================================
name: Reusable - Telegram Notify (Unified Config)

# å®šä¹‰ä¸ºå¯å¤ç”¨å·¥ä½œæµï¼Œå…è®¸å…¶ä»–ä»“åº“è·¨ä»“åº“è°ƒç”¨
on:
  workflow_call:
    # ã€å¤–éƒ¨è°ƒç”¨å¿…å¡«å‚æ•°ã€‘ä»…éœ€ä¼ é€’é€šçŸ¥å†…å®¹ï¼Œæ— éœ€ä¼ é€’ TG å¯†é’¥
    inputs:
      notify_title:
        description: 'TGæ¶ˆæ¯æ ‡é¢˜ï¼ˆè‡ªåŠ¨åŠ ç²—ï¼Œå»ºè®®åŒ…å«ä»»åŠ¡ç±»å‹+çŠ¶æ€ï¼‰'
        required: true
        type: string
      notify_content:
        description: 'TGæ¶ˆæ¯æ­£æ–‡ï¼ˆæ”¯æŒTG Markdownå­é›†ï¼š*åŠ ç²—*ã€[é“¾æ¥](url)ç­‰ï¼‰'
        required: true
        type: string
    # ã€å¯é€‰ã€‘éæ•æ„Ÿé€šç”¨é…ç½®ï¼ˆå¯é€šè¿‡Variablesé…ç½®ï¼Œæ— éœ€æ¯æ¬¡ä¼ é€’ï¼‰
    variables:
      MSG_TIMEZONE:
        description: 'æ¶ˆæ¯æ—¶é—´æ—¶åŒºåç§»ï¼ˆé»˜è®¤+8å°æ—¶ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ï¼‰'
        required: false
        default: '+8 hour'

# ã€æœ€å°æƒé™åŸåˆ™ã€‘ä»…æˆäºˆè¯»å–æƒé™ï¼Œé¿å…æƒé™è¿‡å¤§å¯¼è‡´å®‰å…¨é£é™©
permissions:
  contents: read  # è¯»å–ä»“åº“åŸºç¡€ä¿¡æ¯
  actions: read   # è¯»å–å·¥ä½œæµåŸºç¡€ä¿¡æ¯

jobs:
  # æ ¸å¿ƒä»»åŠ¡ï¼šå‘é€ TG æ¶ˆæ¯
  send-telegram-notification:
    name: Send Message to Telegram
    runs-on: ubuntu-latest
    # å®¹é”™ï¼šä»…å½“ TG å¯†é’¥å­˜åœ¨æ—¶æ‰§è¡Œï¼Œé¿å…ç©ºå€¼æŠ¥é”™
    if: ${{ secrets.TG_BOT_TOKEN != '' && secrets.TG_CHAT_ID != '' }}
    steps:
      - name: Validate TG Config
        run: |
          # éªŒè¯ TG å¯†é’¥æ˜¯å¦æœ‰æ•ˆï¼ˆä»…æ£€æŸ¥é•¿åº¦ï¼Œä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼‰
          if [ ${#TG_BOT_TOKEN} -lt 10 ]; then
            echo "âŒ TG_BOT_TOKEN é…ç½®æ— æ•ˆï¼ˆé•¿åº¦è¿‡çŸ­ï¼‰"
            exit 1
          fi
          if ! [[ $TG_CHAT_ID =~ ^[0-9]+$ ]]; then
            echo "âŒ TG_CHAT_ID é…ç½®æ— æ•ˆï¼ˆéçº¯æ•°å­—ï¼‰"
            exit 1
          fi
          echo "âœ… TG é…ç½®éªŒè¯é€šè¿‡"
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

      - name: Call Telegram Bot API
        run: |
          # æ„é€ å¸¦æ—¶åŒºçš„æ—¶é—´æˆ³
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S' --date='${{ vars.MSG_TIMEZONE }}')
          
          # è°ƒç”¨ TG å®˜æ–¹ API å‘é€æ¶ˆæ¯
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "${{ secrets.TG_CHAT_ID }}",
            "text": "*${{ inputs.notify_title }}*\n\n${{ inputs.notify_content }}\n\nğŸ“… é€šçŸ¥æ—¶é—´ï¼š'"$CURRENT_TIME"'",
            "parse_mode": "Markdown",          # å¯ç”¨Markdownæ ¼å¼
            "disable_web_page_preview": true,  # ç¦ç”¨é“¾æ¥ç½‘é¡µé¢„è§ˆï¼ˆé¿å…æ¶ˆæ¯æ‚ä¹±ï¼‰
            "disable_notification": false      # å¯ç”¨æ¶ˆæ¯æé†’ï¼ˆæ‰‹æœºç«¯éœ‡åŠ¨/é“ƒå£°ï¼‰
          }')
          
          # è§£æ API å“åº”ï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼ˆä¾¿äºæ’æŸ¥é—®é¢˜ï¼‰
          echo "ğŸ“œ TG API å“åº”ï¼š$RESPONSE"
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… TG æ¶ˆæ¯æ¨é€æˆåŠŸ"
          else
            echo "âŒ TG æ¶ˆæ¯æ¨é€å¤±è´¥ï¼Œå“åº”è¯¦æƒ…ï¼š$RESPONSE"
            exit 1
          fi
        env:
          # ä¼ é€’å¯†é’¥åˆ°ç¯å¢ƒå˜é‡ï¼ˆä»…å½“å‰æ­¥éª¤å¯è§ï¼Œå®‰å…¨éš”ç¦»ï¼‰
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
